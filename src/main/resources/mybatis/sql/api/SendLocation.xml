<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kdc.mybatis.mapper.api.SendLocationMapper">
  <!-- 最新履歴取得 -->
  <select id="selectLastRecord" resultType="com.kdc.common.entity.db.UserLocationRecordEntityWrapper">
        SELECT
            UR.user_id                                      AS  userid,
            UR.receive_date                                 AS  receivedate,
            UR.longitude_and_latitude[0]                    AS  latitude,
            UR.longitude_and_latitude[1]                    AS  longitude
        FROM
            user_location_record UR,
            (
                SELECT
                    user_id,
                    MAX(receive_date)  AS  receive_date
                FROM
                    user_location_record
                WHERE
                    del_flg = 0
                AND user_id = #{userid}
                GROUP BY
                    user_id
            ) URMAX
        WHERE
            UR.del_flg = 0
        AND UR.user_id = #{userid}
        AND UR.user_id = URMAX.user_id
        AND UR.receive_date = URMAX.receive_date
  </select>
  <!-- 設定同期日時取得 -->
  <select id="selectConfigSyncDate" resultType="java.sql.Timestamp">
        SELECT
            config_sync_date
        FROM
            user_device
        WHERE
            del_flg = 0
        AND user_id = #{userid}
  </select>
  <!-- 更新日時取得 -->
  <select id="selectUpdateDateUserMaster" resultType="java.sql.Timestamp">
        SELECT
            update_date
        FROM
            user_master
        WHERE
            del_flg = 0
        AND user_id = #{userid}
  </select>
  <!-- ユーザ通知更新日時最新取得 -->
  <select id="selectMaxUpdUserAlertConfig" resultType="java.sql.Timestamp">
        SELECT
            MAX(C.update_date)
        FROM
            user_alert_config C,
            user_master M
        WHERE
            C.notification_auth_level = M.auth_level
        AND C.group_id = M.group_id
        AND C.del_flg = 0
        AND M.del_flg = 0
        AND M.user_id = #{userid}
  </select>
  <!-- 送信間隔更新日時最新取得 -->
  <select id="selectMaxUpdSendIntervalConfig" resultType="java.sql.Timestamp">
        SELECT
            MAX(C.update_date)
        FROM
            send_interval_config C,
            user_master M
        WHERE
            C.auth_level = M.auth_level
        AND C.group_id = M.group_id
        AND C.del_flg = 0
        AND M.del_flg = 0
        AND M.user_id = #{userid}
  </select>
  <!-- 場所通知更新日時最新取得 -->
  <select id="selectMaxUpdPlaceAlertConfig" resultType="java.sql.Timestamp">
        SELECT
            MAX(C.update_date)
        FROM
            place_alert_config C,
            place_master PM,
            user_master M
        WHERE
            C.notification_auth_level = M.auth_level
        AND M.group_id = PM.group_id
        AND C.place_id = PM.place_id
        AND C.del_flg = 0
        AND M.del_flg = 0
        AND M.user_id = #{userid}
  </select>
  <!-- 設定マスタ更新日時最新取得 -->
  <select id="selectMaxUpdConfigMaster" resultType="java.sql.Timestamp">
        SELECT
            MAX(update_date)
        FROM
            config_master
        WHERE
              del_flg = 0
         AND  group_id = #{groupid}
  </select>
  <!-- ユーザ端末更新 -->
  <update id="updateUserDevice" parameterType="com.kdc.common.entity.db.UserDeviceEntity">
        UPDATE
            user_device

        SET
            token_id = #{rec.tokenid},
            update_user_id = #{rec.updateuserid},
            update_date = #{rec.updatedate}

        WHERE
            user_id = #{rec.userid}
        AND del_flg = 0
  </update>
</mapper>