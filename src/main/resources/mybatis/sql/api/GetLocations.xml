<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kdc.mybatis.mapper.api.GetLocationsMapper">
  <select id="getLocationList"
      resultType="com.kdc.mybatis.domain.api.getlocations.UserInfoDomain">
        SELECT
            UL.longitude_and_latitude[0]                    AS  latitude,
            UL.longitude_and_latitude[1]                    AS  longitude,
            UL.moving_distance                              AS  movingdistance,
            UL.battery_level                                AS  batterylevel,
            UL.reception_status                             AS  receptionstatus,
            UL.connection_status                            AS  connectionstatus,
            UL.last_location_date                           AS  lastlocationdate,
            
            UM.user_id                                      AS  userid,
            UM.password                                     AS  password,
            UM.user_name                                    AS  username,
            UM.icon_id                                      AS  iconid,
            UM.group_id                                     AS  groupid,
            UM.auth_level                                   AS  authlevel,
            UM.line_color                                   AS  linecolor,
            UM.marker_color                                 AS  markercolor,

            UC.location_display_flg                         AS  locationdisplayflg,
            UC.moving_distance_display_flg                  AS  movingdistancedisplayflg,
            UC.battery_level_display_flg                    AS  batteryleveldisplayflg,
            UC.access_time_display_flg                      AS  accesstimedisplayflg,
            UC.reception_status_display_flg                 AS  receptionstatusdisplayflg

        FROM
            user_location           UL,
            user_master             UM,
            user_device             UD,
            user_alert_config       UC,
            user_master             UM2
  
        WHERE 
            UL.user_id = UM.user_id
        AND UM.user_id = UD.user_id
        AND UM.auth_level = UC.auth_level
        AND UC.notification_auth_level = UM2.auth_level
        AND UD.telephone_number is not null
        AND UC.location_display_flg = 1
        AND UM.group_id = UC.group_id
        AND UL.del_flg = 0
        AND UM.del_flg = 0
        AND UD.del_flg = 0
        AND UC.del_flg = 0
        AND UM2.del_flg = 0
        AND UM2.user_id = #{userid}
        AND UM.group_id = #{groupid}
        ORDER BY
            UM.disp_order
  </select>

  <select id="getLocationRecordList"
      resultType="com.kdc.common.entity.db.UserLocationRecordEntityWrapper"
        parameterType="com.kdc.common.entity.db.UserLocationRecordEntity">
        SELECT
            receive_date                                    AS  receivedate,
            longitude_and_latitude[0]                       AS  latitude,
            longitude_and_latitude[1]                       AS  longitude,
            battery_level                                   AS  batterylevel,
            reception_status                                AS  receptionstatus
        FROM
            user_location_record
        WHERE
            del_flg = 0
        AND user_id = #{rec.userid}
        AND DATE_TRUNC('day', receive_date) = #{rec.receivedate}
    <if test='sort != null'>
        ORDER BY
      <choose>
        <when test='sort'>
            receive_date
        </when>
        <otherwise>
            receive_date DESC
        </otherwise>
      </choose>
    </if>
  </select>

  <select id="getPlaceAlertRecordList"
      resultType="com.kdc.common.entity.db.PlaceAlertRecordEntity"
        parameterType="com.kdc.common.entity.db.PlaceAlertRecordEntity">
        SELECT
            place_id                                        AS  placeid,
            last_place_alert_date                           AS  lastplacealertdate
        FROM
            place_alert_record
        WHERE
            del_flg = 0
        AND user_id = #{rec.userid}
        ORDER BY
            place_id
  </select>
</mapper>